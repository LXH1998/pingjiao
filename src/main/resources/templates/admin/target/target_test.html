<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Title</title>
    <link type="text/css" th:href="@{/static/layui/css/layui.css}" rel="stylesheet">
    <script type="text/javascript" th:src="@{/static/js/jquery-3.4.0.js}"></script>
    <script type="text/javascript" th:src="@{/static/layui/layui.js}"></script>
    <link rel="stylesheet" type="text/css" th:href="@{/static/zTree_v3/css/zTreeStyle/zTreeStyle.css}" >
    <script type="text/javascript" th:src="@{/static/zTree_v3/js/jquery.ztree.core.js}"></script>
    <script type="text/javascript" th:src="@{/static/zTree_v3/js/jquery.ztree.excheck.js}"></script>
</head>
<style type="text/css">
    /*html{*/
        /*margin: 0;*/
        /*padding: 0;*/
    /*}*/
    body{

    }
</style>

<script type="text/javascript">

    //页面初始化
    $(initIndex());


    //声明一个数组，用于指标选项
    var arrayBox = new Array('A','B','C','D','E','F','G','H','I','J','K','L')
    // zTree的设置
    var setting = {
        // check:{
        //     enable:true
        // },
        data:{
            simpleData:{
                enable:true
            }
        },
        callback: {
            onClick: zTreeOnClick
        }
    };

    //加载页面后的显示
    function initIndex() {

        var url = '/TargetManagement/targetTree'

        // var param = {"role_ID":1};

        $.post(url,function (data) {

            $("#targetManagement").empty()

            //    调用初始化zTree的方法
            initzTree(data);

            //页面初始化，显示添加一级类别的表单
            $('#targetManagement').append('        <div style="width: 100%;">\n' +
                '            <div class="layui-form-item" style="padding:0 0 15px 70px;margin-bottom: 0px;pa;border-bottom: #4E5465 1px solid">\n' +
                '                <label class="layui-form-label">指标类别:</label>\n' +
                '                <div class="layui-input-inline">\n' +
                '                    <input type="text" name="targetName" lay-verify="required" class="layui-input">\n' +
                '                </div>\n' +
                '                <label class="layui-form-label">权重:</label>\n' +
                '                <div class="layui-input-inline">\n' +
                '                    <input type="text" name="targetWeight" lay-verify="required" class="layui-input">\n' +
                '                </div>\n' +
                '                <button type="button" class="layui-btn layui-btn-sm layui-btn-normal" style="margin-top: 4px" onclick="addTargetCategory()">添加</button>\n' +
                '            </div>')

        },"json");
    }

    //树的初始化
    function initzTree(data) {
        // console.log(data);
        //    初始化树
        zTreeObj = $.fn.zTree.init($("#tree"), setting, data);
        //    展开树的节点
        zTreeObj.expandAll(true);
    }

    //用于捕获节点被点击的事件回调函数
    // event-----标准的 js event 对象
    //treeId----对应 zTree 的 treeId(存放zTree标签的id)
    // treeNode----被点击的节点 JSON 数据对象
    function zTreeOnClick(event, treeId, treeNode) {
        // console.log(treeNode)
        // alert(treeNode.targetName)
        $.ajax({
            url:"/TargetManagement/targetOptions",
            data:{
                target_id:treeNode.id
            },
            success:function (res) {
                //动态添加元素之前先全部清除
                $("#targetManagement").empty()
                // alert(treeNode.leafs)
                // $("[name=optionA]").val(res.options[0].options_Content);
                // $("[name=optionAWeight]").val(res.options[0].options_Weight);
                
                //右侧添加上半部div
                $("#targetManagement").append('        <div style="width: 100%;border-bottom: #4E5465 1px solid;padding-bottom: 25px;">\n' +
                    '            <div class="layui-form-item" style="padding-left: 70px">\n' +
                    '                <label class="layui-form-label">指标:</label>\n' +
                    '                <div class="layui-input-inline">\n' +
                    '                    <input type="text" name="targetName" lay-verify="required" class="layui-input" value="'+treeNode.targetName+'">\n' +
                    '                </div>\n' +
                    '                <label class="layui-form-label">权重:</label>\n' +
                    '                <div class="layui-input-inline">\n' +
                    '                    <input type="text" name="targetWeight" lay-verify="required" class="layui-input" value="'+treeNode.targetWeight+'">\n' +
                    '                </div>\n' +
                    '                <button type="button" class="layui-btn layui-btn-sm layui-btn-normal layui-btn-danger" style="margin-top: 4px" onclick="deleteTargetCategory('+treeNode.id+','+treeNode.pId+')"><i class="layui-icon"></i> 删除</button>\n' +
                    '            </div>\n' +
                    '\n' +
                    '            <div style="width:400px;margin: 0 auto">\n' +
                    '                <button type="button" class="layui-btn  layui-btn-sm layui-btn-normal" style="padding: 0 20px">增加下级指标</button>\n' +
                    '                <button type="button" class="layui-btn  layui-btn-sm layui-btn-normal" style="margin-left: 20px;padding: 0 20px">指标维护</button>\n' +
                    '                <button type="button" class="layui-btn  layui-btn-sm layui-btn-normal" style="margin-left: 20px;padding: 0 20px">保存修改</button>\n' +
                    '            </div>\n' +
                    '        </div>');
                

                //右侧下半部分div
                if (treeNode.leafs==-1){
                    $('#targetManagement').append('        <div style="width:100%;height:325px;">\n' +
                        '            <fieldset class="layui-elem-field site-demo-button" >\n' +
                        '                <legend>指标维护</legend>\n' +
                        '                <div  style="margin-bottom: 10px;">\n' +
                        '                    <button type="button" class="layui-btn">添加选项</button>\n' +
                        '                </div>\n' +
                        '                <form id="addOptions" class="layui-form layui-form-pane" style="height:252px;padding-left:150px;overflow: auto">\n' +
                        '                </form>\n' +
                        '            </fieldset>\n' +
                        '        </div>')
                    if (res.options.length!=0){
                        for (var i=0;i<res.options.length;i++){
                            $('#addOptions').append('<div class="layui-form-item">\n' +
                                '                        <div class="layui-inline">\n' +
                                '                            <label class="layui-form-label">选项'+arrayBox[i]+':</label>\n' +
                                '                            <div class="layui-input-inline" style="width: 400px">\n' +
                                '                                <input type="hidden" name="id" value="'+res.options[i].options_Id+'">\n' +
                                '                                <input type="text" name="optionA" lay-verify="required" class="layui-input" readonly="true" value="'+res.options[i].options_Content+'">\n' +
                                '                            </div>\n' +
                                '                        </div>\n' +
                                '                        <div class="layui-inline">\n' +
                                '                            <div class="layui-input-inline" style="width: 50px">\n' +
                                '                                <input type="text" name="optionAWeight" lay-verify="required" class="layui-input" readonly="true" style="padding-left:0px;text-align: center" value="'+res.options[i].options_Weight+'">\n' +
                                '                            </div>\n' +
                                '                        </div>\n' +
                                '                        <div class="layui-inline">\n' +
                                '                            <div class="layui-input-inline" style="width: 50px">\n' +
                                '                                <button type="button" class="layui-btn layui-btn-sm layui-btn-normal layui-btn-danger">删除</button>\n' +
                                '                            </div>\n' +
                                '                        </div>\n' +
                                '                    </div>')
                        }
                    }

                }
            }
        })
        // $("[name=targetName]").val(treeNode.targetName);
        // $("[name=targetWeight]").val(treeNode.targetWeight);
    };
</script>
<body>
<div style="width: 1120px;height: 435px;">
    <div style="width: 19%;height: 435px;float: left;box-sizing:border-box;border-right: #4E5465 1px solid;">
        <ul id="tree" class="ztree" style="height:435px; overflow:auto;"></ul>
    </div>
    <div id="targetManagement" style="width: 81%;height: 100%; float: left">
        <!--<div style="background-color:#007DDB;width: 100%">-->
            <!--<div class="layui-form-item" style="padding-left: 70px">-->
                <!--<label class="layui-form-label">指标名称:</label>-->
                <!--<div class="layui-input-inline">-->
                    <!--<input type="text" name="targetName" lay-verify="required" class="layui-input">-->
                <!--</div>-->
                <!--<label class="layui-form-label">指标权重:</label>-->
                <!--<div class="layui-input-inline">-->
                    <!--<input type="text" name="targetWeight" lay-verify="required" class="layui-input">-->
                <!--</div>-->
                <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-normal layui-btn-danger" style="margin-top: 4px"><i class="layui-icon"></i> 删除</button>-->
            <!--</div>-->

            <!--<div style="width:400px;margin: 0 auto">-->
                <!--<button type="button" class="layui-btn  layui-btn-sm layui-btn-normal" style="padding: 0 20px">增加下级指标</button>-->
                <!--<button type="button" class="layui-btn  layui-btn-sm layui-btn-normal" style="margin-left: 20px;padding: 0 20px">指标维护</button>-->
                <!--<button type="button" class="layui-btn  layui-btn-sm layui-btn-normal" style="margin-left: 20px;padding: 0 20px">保存修改</button>-->
            <!--</div>-->
        <!--</div>-->
        <!--<div style="width:100%;height:325px;background-color:yellow">-->
            <!--<fieldset class="layui-elem-field site-demo-button" style="margin-top: 25px;">-->
                <!--<legend>指标维护</legend>-->
                <!--<div style="margin-bottom: 10px;">-->
                    <!--<button type="button" class="layui-btn">添加选项</button>-->
                <!--</div>-->
                <!--<form class="layui-form layui-form-pane" style="height:252px;padding-left:150px;overflow: auto">-->
                    <!--<div class="layui-form-item">-->
                        <!--<div class="layui-inline">-->
                            <!--<label class="layui-form-label">选项A:</label>-->
                            <!--<div class="layui-input-inline" style="width: 400px">-->
                                <!--<input type="hidden" name="id">-->
                                <!--<input type="text" name="optionA" lay-verify="required" class="layui-input">-->
                            <!--</div>-->
                        <!--</div>-->
                        <!--<div class="layui-inline">-->
                            <!--<div class="layui-input-inline" style="width: 50px">-->
                                <!--<input type="text" name="optionAWeight" lay-verify="required" class="layui-input">-->
                            <!--</div>-->
                        <!--</div>-->
                        <!--<div class="layui-inline">-->
                            <!--<div class="layui-input-inline" style="width: 50px">-->
                                <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-normal layui-btn-danger">删除</button>-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                    <!--<div class="layui-form-item">-->
                        <!--<div class="layui-inline">-->
                            <!--<label class="layui-form-label">选项B:</label>-->
                            <!--<div class="layui-input-inline" style="width: 400px">-->
                                <!--<input type="text" name="optionB" lay-verify="required" class="layui-input">-->
                            <!--</div>-->
                        <!--</div>-->
                        <!--<div class="layui-inline">-->
                            <!--<div class="layui-input-inline" style="width: 50px">-->
                                <!--<input type="text" name="optionBWeight" lay-verify="required" class="layui-input">-->
                            <!--</div>-->
                        <!--</div>-->
                        <!--<div class="layui-inline">-->
                            <!--<div class="layui-input-inline" style="width: 50px">-->
                                <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-normal layui-btn-danger">删除</button>-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                    <!--<div class="layui-form-item">-->
                        <!--<div class="layui-inline">-->
                            <!--<label class="layui-form-label">选项C:</label>-->
                            <!--<div class="layui-input-inline" style="width: 400px">-->
                                <!--<input type="text" name="optionC" lay-verify="required" class="layui-input">-->
                            <!--</div>-->
                        <!--</div>-->
                        <!--<div class="layui-inline">-->
                            <!--<div class="layui-input-inline" style="width: 50px">-->
                                <!--<input type="text" name="optionCWeight" lay-verify="required" class="layui-input">-->
                            <!--</div>-->
                        <!--</div>-->
                        <!--<div class="layui-inline">-->
                            <!--<div class="layui-input-inline" style="width: 50px">-->
                                <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-normal layui-btn-danger">删除</button>-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                    <!--<div class="layui-form-item">-->
                        <!--<div class="layui-inline">-->
                            <!--<label class="layui-form-label">选项D:</label>-->
                            <!--<div class="layui-input-inline" style="width: 400px">-->
                                <!--<input type="text" name="optionD" lay-verify="required" class="layui-input">-->
                            <!--</div>-->
                        <!--</div>-->
                        <!--<div class="layui-inline">-->
                            <!--<div class="layui-input-inline" style="width: 50px">-->
                                <!--<input type="text" name="optionDWeight" lay-verify="required" class="layui-input">-->
                            <!--</div>-->
                        <!--</div>-->
                        <!--<div class="layui-inline">-->
                            <!--<div class="layui-input-inline" style="width: 50px">-->
                                <!--<button type="button" class="layui-btn layui-btn-sm layui-btn-normal layui-btn-danger">删除</button>-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                <!--</form>-->
            <!--</fieldset>-->
        <!--</div>-->
    </div>
</div>


<script type="text/javascript">
    var layer

    layui.use('layer',function () {
        layer = layui.layer
    })


    //添加指标类别
    function addTargetCategory() {
        var targetName = $("[name=targetName]").val();
        var targetWeight = $("[name=targetWeight]").val();
        if (targetWeight.replace(/(^\s*)|(\s*$)/g, "") == ""){
            targetWeight = 0;
        }

        if (!(targetName.replace(/(^\s*)|(\s*$)/g, "") == "")){
            $.ajax({
                url:'/TargetManagement/addTargetCategory',
                data:{
                    target_Name:targetName,
                    target_Weight:targetWeight
                },
                success:function (res) {
                    if (res.message=="操作成功"){
                        layer.msg(res.message);
                        initIndex()
                    } else {
                        layer.msg(res.message);
                    }
                },
                error:function () {
                    layer.msg("异常")
                }
            })
        }
    }


//    删除指标
    function deleteTargetCategory(id,pId) {
        var treeObj = $.fn.zTree.getZTreeObj("tree");
        //获得指点id节点
        var node = treeObj.getNodeByParam("id", id);

        $.ajax({
            url:'/TargetManagement/deleteTarget',
            data:{
                target_Id:id
            },
            success:function (res) {
                if (res.message=="操作成功"){
                    if (pId==null){
                        //获取指定节点的下一节点
                        var nextnode = node.getNextNode()
                        var prenode = node.getPreNode();
                        treeObj.removeNode(node)
                        if (nextnode!=null){
                            $("#"+nextnode.tId+"_a").click();
                        }else if (prenode!=null){
                            $("#"+prenode.tId+"_a").click();
                        }else {
                            //页面初始化，显示添加一级类别的表单
                            $('#targetManagement').append('        <div style="width: 100%;">\n' +
                                '            <div class="layui-form-item" style="padding:0 0 15px 70px;margin-bottom: 0px;pa;border-bottom: #4E5465 1px solid">\n' +
                                '                <label class="layui-form-label">指标类别:</label>\n' +
                                '                <div class="layui-input-inline">\n' +
                                '                    <input type="text" name="targetName" lay-verify="required" class="layui-input">\n' +
                                '                </div>\n' +
                                '                <label class="layui-form-label">权重:</label>\n' +
                                '                <div class="layui-input-inline">\n' +
                                '                    <input type="text" name="targetWeight" lay-verify="required" class="layui-input">\n' +
                                '                </div>\n' +
                                '                <button type="button" class="layui-btn layui-btn-sm layui-btn-normal" style="margin-top: 4px" onclick="addTargetCategory()">添加</button>\n' +
                                '            </div>')
                        }
                    } else {
                        var nextnode = node.getNextNode()
                        var prenode = node.getPreNode();
                        var parentnode = node.getParentNode();
                        treeObj.removeNode(node)
                        if (nextnode!=null){
                            $("#"+nextnode.tId+"_a").click();
                        }else if (prenode!=null){
                            $("#"+prenode.tId+"_a").click();
                        }else {
                            $("#"+parentnode.tId+"_a").click();
                        }
                    }
                    layer.msg(res.message)
                }else {
                    layer.msg(res.message)
                }
            }
        })
    }


</script>
</body>
</html>